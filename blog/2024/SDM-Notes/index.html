<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Notes of Score Diffusion Models (updating) | Yiming Che (车一鸣) </title> <meta name="author" content="Yiming Che"> <meta name="description" content="This is a summary of unified framework of diffusion models by Stochastic Differential Equations (SDE) and the related topics."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/che.jpg?cb45d92e8d9c4d4cdb80894d70e4a1ef"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://soloche.github.io/blog/2024/SDM-Notes/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams",packages:{"[+]":["configmacros"]},macros:{R:"{\\mathbb{R}}",f:"{\\bf f}",w:"{\\boldsymbol{w}}",x:"{\\boldsymbol{x}}",I:"{\\boldsymbol{I}}",nbr:["\\left(#1\\right)",1],sbr:["\\left[#1\\right]",1],bm:["\\boldsymbol{#1}",1],bs:["\\boldsymbol{#1}",1],N:"{\\mathcal{N}}",argmax:["\\underset{#1}{\\operatorname{argmax}}",1],argmin:["\\underset{#1}{\\operatorname{argmin}}",1]},inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]]}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">
      {
            "title": "Notes of Score Diffusion Models (updating)",
            "description": "This is a summary of unified framework of diffusion models by Stochastic Differential Equations (SDE) and the related topics.",
            "published": "September 24, 2024",
            "authors": [
              
              {
                "author": "Yiming Che",
                "authorURL": "",
                "affiliations": [
                  {
                    "name": "Arizona State University",
                    "url": ""
                  }
                ]
              }
              
            ],
            "katex": {
              "delimiters": [
                {
                  "left": "$",
                  "right": "$",
                  "display": false
                },
                {
                  "left": "$$",
                  "right": "$$",
                  "display": true
                }
              ]
            }
          }
    </script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Yiming Che (车一鸣) </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="post distill"> <d-title> <h1>Notes of Score Diffusion Models (updating)</h1> <p>This is a summary of unified framework of diffusion models by Stochastic Differential Equations (SDE) and the related topics.</p> </d-title> <d-byline></d-byline> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div> <a href="#background">Background</a> </div> <ul> <li> <a href="#data-perturbation-with-it%C3%B4-sde">Data Perturbation with Itô SDE</a> </li> <li> <a href="#probability-flow-ode">Probability Flow ODE</a> </li> <li> <a href="#connection-between-pf-ode-and-sde">Connection Between PF ODE and SDE</a> </li> <li> <a href="#reverse-sde">Reverse SDE</a> </li> <li> <a href="#summary">Summary</a> </li> </ul> <div> <a href="#unified-framework-of-score-diffusion-models">Unified Framework of Score Diffusion Models</a> </div> </nav> </d-contents> <h1 id="background">Background</h1> <p>In score-based diffusion models <d-cite key="songscore"></d-cite>, the authors proposed a unified framework that connects the score-based model NCSN and DDPM through the perspective of Stochastic Differential Equations (SDE). They interpret the forward process (adding noise) and the backward process (denoising sampling) as SDE and reverse SDE, respectively.</p> <h2 id="data-perturbation-with-itô-sde">Data Perturbation with Itô SDE</h2> <p>The diffusion process ${\x_t}_{t=0}^T$ from the original input $\x_0$ to Gaussian noise $\x_T$ with continuous time variable $t\in\sbr{0,T}$ can be modeled by the Itô SDE</p> \[\begin{equation} d\x = \f(\x, t) dt + \bs{G}(\x, t)d\w_t \end{equation}\] <ul> <li>$\w_t$ is the standard Wiener process. $\w_t\sim \N(0, t) \rightarrow \w_{t+\Delta t}-\w_t\sim \N(0, \Delta t) \rightarrow d\w_t \sim \sqrt{\Delta t}\bs{\epsilon} \quad \bs{\epsilon}\sim \N(0,\I)$</li> <li>$\f(\x,t): \mathbb{R}^d \rightarrow \mathbb{R}^d$ are the drift coefficients and $d$ is the dimension of $\x$. It is always affine, resulting in $f(\x, t) = f(t)\x$ where $f(\cdot):\mathbb{R} \rightarrow \mathbb{R}$.</li> <li>$\bs{G}(\x,t): \mathbb{R}^d \rightarrow \mathbb{R}^{d\times d}$ are the diffusion coefficients at time $t$.</li> </ul> <p>We consider the case $\bs{G}(\x,t) = g(t)\I$ which is independent of $\x$. Then, Eq. (1) can be rewritten as</p> \[\begin{equation} d\x = f(t)\x dt + g(t)d\w_t \label{eq:forward-sde} \end{equation}\] <p>The perturbation kernel of this SDE have the form</p> \[\begin{equation} p(\x_t \mid \x_0) = \N(\x_t \mid s_t\x_0, s_t^2\sigma_t^2\I) \end{equation}\] <p>where</p> \[\begin{equation} s_t = \exp\nbr{\int_0^t f(\xi)d\xi} \quad \text{and}\quad \sigma_t^2 = \int_0^t\nbr{\frac{g(\xi)}{s(\xi)}}^2d\xi \end{equation}\] <p>Here, I’ll use $s_t$ and $s(t)$, and $\sigma_t$ and $\sigma(t)$ interchangeably for simplicity. The corresponding marginal distribution is obtained by</p> \[\begin{align} p(\x_t) &amp;= \int p(\x_t \mid \x_0)p_{data}(\x_0)d\x_0\\ &amp;= s_t^{-d}\int p_{data}(\x_0)\N(\x_ts_t^{-1} \mid \x_0, \sigma_t^2\I)d\x_0\\ &amp;= s_t^{-d}\int p_{data}(\x_0)\N(\x_ts_t^{-1}-\x_0 \mid 0, \sigma_t^2\I)d\x_0\\ &amp;= s_t^{-d} \sbr{p_{data}(\x_0) * \N\nbr{0, \sigma_t^2\I}}(\x_ts_t^{-1})\\ &amp;= s_t^{-d} p(\x_ts_t^{-1};\sigma_t) \label{eq:marginal} \end{align}\] <p>The <a href="https://en.wikipedia.org/wiki/Fokker%E2%80%93Planck_equation" rel="external nofollow noopener" target="_blank">Fokker-Plank equation</a> describes the evolution of the marginal distribution $p_t(\x)$, interchangeable with $p(\x_t)$, over time under the effect of drift forces and random (or noise) forces. It can be written as</p> \[\begin{align} \frac{\partial p_t(\x)}{\partial t} &amp;= -\nabla_{\x}\sbr{\f(\x,t) p_t(\x)} + \frac{1}{2}\nabla_{\x}\nabla_{\x}\sbr{\bs{G}(\x,t)\bs{G}^T(\x,t)p_t(\x)}\\ &amp;= -\sum_{i=1}^{d}\frac{\partial}{\partial x_i}\sbr{f_i(\x,t)p_t(\x)} + \frac{1}{2}\sum_{i=1}^{d}\sum_{j=1}^{d}\frac{\partial^2}{\partial \x_i \partial \x_j}\sbr{\sum_{k=1}^{d} G_{ik}(\x, t)G_{jk}(\x, t) p_t(\x)}\\ &amp;= -\sum_{i=1}^{d}\frac{\partial}{\partial x_i}\sbr{f_i(\x,t)p_t(\x) -\frac{1}{2}\sbr{\nabla_{\x}\sbr{\bs{G}(\x,t)\bs{G}^T(\x,t)} + \bs{G}(\x,t)\bs{G}^T(\x,t)\nabla_{\x}\log p_t(\x)}p_t(\x)}\\ &amp;= -\sum_{i=1}^{d}\frac{\partial}{\partial x_i}\sbr{\tilde{f}_i(\x,t)p_t(\x)} \label{eq:fokker-planck} \end{align}\] <p>where</p> \[\tilde{f}_i(\x,t) = f_i(\x,t) - \frac{1}{2}\sbr{\nabla_{\x}\sbr{\bs{G}(\x,t)\bs{G}^T(\x,t)} + \bs{G}(\x,t)\bs{G}^T(\x,t)\nabla_{\x}\log p_t(\x)}.\] <p>If we consider the case $\bs{G}(\x,t) = g(t)\I$ which is independent of $\x$, then Eq. $\ref{eq:fokker-planck}$ can be rewritten as</p> \[\begin{align} \frac{\partial p_t(\x)}{\partial t} &amp;= -\nabla_{\x}\sbr{f(\x,t)p_t(\x)} + \frac{1}{2}g^2(t)\nabla_{\x}\nabla_{\x}\sbr{p_t(\x)}\\ &amp;= -\sum_{i=1}^{d}\frac{\partial}{\partial x_i}\sbr{\sbr{f_i(\x,t)-\frac{1}{2}g^2(t)\nabla_{\x}\log p_t(\x)}p_t(\x)} \label{eq:fokker-planck-special} \end{align}\] <h2 id="probability-flow-ode">Probability Flow ODE</h2> <p>According to the <a href="https://en.wikipedia.org/wiki/Fokker%E2%80%93Planck_equation" rel="external nofollow noopener" target="_blank">Fokker-Plank equation</a>, there exists an ODE which shares the same marginal distribution $p(\x)$ as the SDE. From Eq. $\ref{eq:fokker-planck-special}$, the corresponding SDE is reduced to ODE given by</p> \[\begin{align} d\x &amp;= \sbr{f(\x, t) - \frac{1}{2}g^2(t)\nabla_{\x}\log p_t(\x)}dt + 0d\w_t \\ &amp;= \sbr{f(t)\x - \frac{1}{2}g^2(t)\nabla_{\x}\log p_t(\x)}dt \label{eq:prob-flow-ode} \end{align}\] <p>The ODE is named as the probability flow ODE (PF ODE).</p> <p>If we further build the ODE according to $s_t$ and $\sigma_t$, we have</p> \[\begin{equation} f(t) = \dot{s}_ts_t^{-1} \quad \text{and} \quad g_t = s_t\sqrt{2\dot{\sigma}_t\sigma_t}. \end{equation}\] <p>The derivation can be found in EDM paper <d-cite key="karras2022elucidating"></d-cite> (Eq. 28 and 34). Then, Eq. $\ref{eq:prob-flow-ode}$ can be rewritten as</p> \[\begin{align} d\x &amp;= \sbr{\dot{s}_ts_t^{-1}\x - s_t^2\dot{\sigma}_t\sigma_t\nabla_{\x}\log p_t(\x)}dt\\ &amp;= \sbr{\dot{s}_ts_t^{-1}\x - s_t^2\dot{\sigma}_t\sigma_t\nabla_{\x}\log p(\x s_t^{-1};\sigma_t)}dt\\ &amp;= \sbr{ -\dot{\sigma}_t\sigma_t\nabla_{\x}\log p(\x_t;\sigma_t)}dt \quad \text{where} \quad s_t = 1 \end{align}\] <p>where the marginal $p_t(\x) = s^{-1}_t p(\x_t s_t^{-1};\sigma_t)$ and</p> \[p(\x_ts_t^{-1}; \sigma_t) = \sbr{p_{data}(\x_0) * \N\nbr{0, \sigma_t^2\I}}(\x_ts_t^{-1})\] <p>as shown in Eq. $\ref{eq:marginal}$.</p> <h2 id="connection-between-pf-ode-and-sde">Connection Between PF ODE and SDE</h2> <p>According to the Eq. (102) in <d-cite key="karras2022elucidating"></d-cite>, the authors derived a family of SDE for any choice of $g(t)$. The SDE is given by</p> \[\begin{align} d\x &amp;= \nbr{\frac{1}{2}g^2(t) - \dot{\sigma}_t\sigma_t}\nabla_{\x}\log p(\x;\sigma_t)dt + g(t)d\w_t\\ &amp;= \hat{\f}(\x, t)dt + g(t)d\w_t \label{eq:general-sde} \end{align}\] <p>The PF ODE is a special case of the SDE when $g(t) = 0$. The derivation is given in the EDM paper <d-cite key="karras2022elucidating"></d-cite> (Appendix B.5). It is a little bit long but not difficult to follow. Furthermore, the authors parameterized $g(t) = \sqrt{2\beta(t)}\sigma_t$ and Eq. $\ref{eq:general-sde}$ becomes</p> \[\begin{equation} d\x = - \dot{\sigma}_t\sigma_t\nabla_{\x}\log p(\x;\sigma_t)dt + \beta(t)\sigma_t^2\nabla_{\x}\log p(\x;\sigma_t)dt + \sqrt{2\beta(t)}\sigma_td\w_t \label{eq:general-sde-beta} \end{equation}\] <p>where $\beta(t)$ is a free function.</p> <h2 id="reverse-sde">Reverse SDE</h2> <p>The reverse diffusion process from $\x_T$ to $\x_0$ can also be modeled by Itô SDE according to <d-cite key="anderson1982reverse"></d-cite>:</p> \[\begin{align} d\x &amp;= \sbr{\hat{\f}(\x,t) - g^2(t)\nabla_{\x}\log p_t(\x)}dt + g(t)d\w_t \\ &amp;= - \dot{\sigma}_t\sigma_t\nabla_{\x}\log p(\x;\sigma_t)dt \underbrace{- \beta(t)\sigma_t^2\nabla_{\x}\log p(\x;\sigma_t)dt + \sqrt{2\beta(t)}\sigma_td\w_t}_{\text{Langevin dynamics: noise cancellation}} \end{align}\] <h1 id="unified-framework-of-score-diffusion-models">Unified Framework of Score Diffusion Models</h1> <h2 id="ncsn-ve-sde">NCSN (VE SDE)</h2> <h2 id="ddpm-vp-sde">DDPM (VP SDE)</h2> <h2 id="ddim">DDIM</h2> <h2 id="preconditioning">Preconditioning</h2> <h2 id="sampling">Sampling</h2> <h1 id="related-topics">Related Topics</h1> <h2 id="flow-matching">Flow Matching</h2> <h2 id="consistency-model">Consistency Model</h2> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/ref.bib"></d-bibliography> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Yiming Che. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. Last updated: January 08, 2025. </div> </footer> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> </body> </html>